# 猫仔文本处理工具套件 V2.0

> 该作品由 lovelycateman/www.52pojie.cn 开源，人人为我，我为人人

## 📚 工具简介

本套件包含三个强大的文本处理工具，帮助您高效处理大型文本文件：

1. **猫仔文本分割器** - 智能分割大文本文件
2. **猫仔多文伴侣** - AI驱动的批量文本处理工具
3. **猫仔文本一键合并** - 智能合并处理后的文本文件

---

## 🔧 工具一：猫仔文本分割器

### 功能概述
将大型文本文件智能分割成多个小文件，支持三种分割模式，适用于AI模型处理、数据清洗等场景。

### 核心功能
- ✅ **三种分割模式**：
  - **模式 A**：Token精细分块（保留句子边界，智能重叠）
  - **模式 B**：按章节分块（自动识别章节标题，保持完整性）
  - **模式 C**：章节段落混合模式（先章节后Token细分）

- ✅ **智能特性**：
  - Token精确计算（基于tiktoken）
  - 句子边界识别（避免截断句子）
  - 章节自动检测（支持中英文章节标题）
  - 段落格式保留
  - 重叠率可调（避免上下文丢失）

### 使用方法

1. **启动程序**
   ```bash
   python 猫仔文本分割器.py
   ```

2. **选择文件**
   - 点击"选择文件"按钮
   - 选择需要分割的 .txt 文件
   - 程序自动显示文件信息和Token数量

3. **配置参数**
   
   **模式 A（Token精细分块）**：
   - `目标 Token 大小`：每个块的目标Token数（默认2500）
   - `重叠率`：相邻块之间的重叠比例（0-1，默认0.05）
   - `最小区块比例`：最小块占目标大小的比例（0-1，默认0.2）

   **模式 B（按章节分块）**：
   - `最大 Token 上限`：单个章节的Token上限（默认5000）
   - 超过上限的章节会合并到下一块

   **模式 C（混合模式）**：
   - 结合模式A和B的参数
   - 先按章节分割，超限章节再用Token模式细分

4. **开始分割**
   - 点击"开始分块"按钮
   - 等待处理完成
   - 自动打开输出文件夹

### 输出说明

输出目录结构：
```
OUT/
└── 时间戳_原文件名/
    ├── 原文件名_chunks/
    │   ├── 原文件名_001.txt
    │   ├── 原文件名_002.txt
    │   └── ...
    └── metadata/
        └── 原文件名_metadata.json
```

- **模式A/C**：生成 `原文件名_001.txt`、`原文件名_002.txt` 等
- **模式B**：生成 `原文件名_chunk_001(章节标题).txt` 格式
- **metadata.json**：包含分块信息、Token统计等元数据

---

## 🤖 工具二：猫仔多文伴侣

### 功能概述
强大的AI驱动批量文本处理工具，支持自定义提示词、相似度检测、错误纠正等高级功能。

### 核心功能

- ✅ **批量处理**：
  - 文件夹模式：批量处理整个文件夹的txt文件
  - 文档模式：单独处理指定文件
  - 并发处理：可配置并发数提高效率

- ✅ **AI集成**：
  - 支持OpenAI兼容API（本地/云端）
  - 自定义系统提示词
  - 可选系统预设
  - 参数可调（temperature、top_p等）

- ✅ **智能检测**：
  - 相似度检测（防止AI复读原文）
  - 自动重试机制
  - 错误标记和日志

- ✅ **高级功能**：
  - 🔧 **一键纠错**：自动重新处理所有失败文件
  - 🔄 **循环纠错**：循环处理直到全部成功
  - ✨ **优化文档**：选择特定文件重新处理
  - 📋 **汇总输出**：智能合并处理结果
  - 正则后处理：自定义正则规则清理输出

- ✅ **配置管理**：
  - API密钥管理（保存/加载/删除）
  - 默认配置保存
  - 提示词/预设/正则规则保存与加载

### 使用方法

1. **启动程序**
   ```bash
   python 猫仔多文伴侣.py
   ```

2. **配置API**
   - 输入API地址（如：`http://127.0.0.1:9093/v1/chat/completions`）
   - 输入API密钥（可选，点击"加载"使用已保存的密钥）
   - 点击"测试连接"验证API并获取模型列表
   - 选择使用的模型
   - 点击"保存配置"

3. **选择输入文件**
   - 选择输入模式：
     - **文件夹模式**：处理文件夹内所有txt文件
     - **文档模式**：处理单个txt文件
   - 点击"选择输入文档/文件夹"
   - 查看文件预览确认

4. **配置处理参数**
   - **系统提示词**：定义AI的处理任务（必填）
   - **系统预设**：可选的系统级设定
   - **正则规则**：后处理正则替换规则（格式：`pattern|replacement`）
   - **参数调整**：
     - 超时时间（秒）
     - 并发数（建议1-4）
     - 重试次数（建议2-5）
     - 相似度阈值（30-100%，默认40%）

5. **开始处理**
   - 点击"▶ 开始"按钮
   - 实时监控进度和状态
   - 可随时"⏸ 暂停/继续"

6. **后期优化**
   - **一键纠错**：自动重处理失败文件
   - **循环纠错**：持续重试直到全部成功
   - **优化文档**：选择特定文件重新处理
   - **汇总输出**：合并所有处理结果

### 配置文件说明

程序会自动生成以下配置文件：
- `config.json` - API配置
- `api_keys.json` - 保存的API密钥
- `default_profile.json` - 默认配置模板

### 输出说明

输出目录结构：
```
OUT/
└── 时间戳_原文件夹名/
    ├── 文件1_processed.txt
    ├── 文件2_processed.txt
    ├── 文件3_error.txt（失败文件）
    └── ...
```

### 提示词示例

```
核心原则：
1. 仅输出结果，不展示分析过程
2. 保留所有重要情节和细节
3. 转述对话，保留语气效果
4. 动作具象化，避免抽象概括
5. 输出格式：包裹在 <content> 与 </content> 标签中
```

### 正则规则示例

```
.*?<content>|          # 删除<content>标签前的内容
</content>.*|          # 删除</content>标签后的内容
\n\n\n+|\n\n          # 多个空行替换为两个
```

---

## 📋 工具三：猫仔文本一键合并

### 功能概述
智能识别文件命名模式，自动合并分割或处理后的文本文件。

### 核心功能

- ✅ **智能识别**：
  - 自动检测文件命名模式
  - 支持任意前缀+数字+后缀格式
  - 区分不同命名规则组

- ✅ **灵活合并**：
  - 按编号自动排序
  - 添加段落标记
  - 支持多种命名模式同时处理

- ✅ **循环模式**：
  - 可连续处理多个文件夹
  - 自动打开输出文件夹

### 使用方法

1. **启动程序**
   ```bash
   python 猫仔文本一键合并.py
   ```

2. **选择文件夹**
   - 程序提示后选择包含待合并txt文件的文件夹
   - 支持的文件命名格式：
     - `AAA_chunk_001BBB.txt`
     - `test1result.txt`
     - `file_001.txt`
     - 任何包含数字的txt文件

3. **自动处理**
   - 程序自动识别命名模式
   - 按数字顺序合并
   - 生成 `原前缀_原后缀_zong.txt`

4. **继续或退出**
   - 按 Enter 继续处理其他文件夹
   - 输入 'q' 退出程序

### 输出格式

```
【段落001】
第一个文件的内容
----
【段落002】
第二个文件的内容
----
【段落003】
第三个文件的内容
```

### 示例

**输入文件**：
```
第一章_001.txt
第一章_002.txt
第一章_003.txt
```

**输出文件**：
```
第一章__zong.txt
```

---

## 🔄 完整工作流程示例

### 场景：处理大型小说文件

1. **第一步：分割文件**
   - 使用"猫仔文本分割器"
   - 选择模式B（按章节分块）
   - 设置最大Token为5000
   - 输出：50个章节文件

2. **第二步：AI处理**
   - 使用"猫仔多文伴侣"
   - 配置API和提示词
   - 文件夹模式批量处理
   - 如有失败，使用"一键纠错"或"循环纠错"
   - 输出：50个处理后的文件

3. **第三步：合并结果**
   - 使用"猫仔文本一键合并"
   - 选择输出文件夹
   - 自动合并为单个文件
   - 输出：完整的处理后文本

---

## 💡 使用技巧

### 文本分割器
- 处理小说建议用模式B（章节分块）
- 处理论文建议用模式A（Token精细分块）
- 超大章节建议用模式C（混合模式）
- 调整重叠率避免上下文丢失（建议0.05-0.1）

### 多文伴侣
- **相似度阈值**：
  - 改写任务：30-40%
  - 翻译任务：50-60%
  - 摘要任务：20-30%
  
- **并发数设置**：
  - 本地API：2-4
  - 云端API：1-2（避免限流）
  
- **提示词优化**：
  - 明确任务目标
  - 给出具体示例
  - 使用输出格式标签

- **错误处理**：
  - 优先使用"循环纠错"
  - 检查失败文件的error.txt日志
  - 调整相似度阈值或提示词

### 文本合并器
- 确保文件命名包含数字编号
- 数字位置保持一致（前缀+数字+后缀）
- 合并前检查文件完整性

---

## 📦 环境要求

### Python版本
- Python 3.7 或更高版本

### 依赖库

**文本分割器**：
```bash
pip install tiktoken
```

**多文伴侣**：
```bash
pip install requests
```

**文本合并器**：
无需额外依赖（仅使用Python标准库）

### 快速安装
```bash
pip install tiktoken requests
```

---

## ⚙️ 配置说明

### API配置（多文伴侣）

**支持的API类型**：
- ✅ OpenAI官方API
- ✅ 本地模型API（vLLM、Ollama等）
- ✅ 其他OpenAI兼容API

**配置示例**：
```json
{
  "api_url": "http://127.0.0.1:9093/v1/chat/completions",
  "api_key": "your-api-key",
  "selected_model": "Qwen2.5-14B-Instruct",
  "timeout": 600,
  "max_workers": 2,
  "max_retries": 3,
  "similarity_threshold": 40
}
```

---

## 🐛 常见问题

### Q1: 分割器提示"无法用任何支持的编码读取文件"
**A**: 文件编码不支持，建议将文件转换为UTF-8编码。

### Q2: 多文伴侣连接API失败
**A**: 
- 检查API地址是否正确
- 确认API服务正在运行
- 检查网络连接和防火墙设置

### Q3: 相似度过高导致处理失败
**A**: 
- 优化提示词，强调"禁止复读原文"
- 降低temperature参数
- 增加presence_penalty和frequency_penalty

### Q4: 合并器无法识别文件
**A**: 
- 确保文件名包含数字
- 检查文件扩展名为.txt
- 数字前应有非空前缀

### Q5: 处理速度慢
**A**: 
- 增加并发数（max_workers）
- 使用更快的API服务
- 减小文件块大小

---

## 📝 更新日志

### V2.0 (2026-01-15)
- ✨ 新增：文本分割器模式C（混合模式）
- ✨ 新增：多文伴侣文件并发功能
- ✨ 新增：多文伴侣自动查重/自动重试/一键纠错/循环纠错功能
- ✨ 新增：优化文档功能
- ✨ 新增：API密钥管理
- ✨ 新增：默认配置保存
- 🔧 优化：相似度计算排除标点符号
- 🔧 优化：UI界面和用户体验
- 🐛 修复：文件编码识别问题

---

## 📄 开源协议

本项目采用开源协议，人人为我，我为人人。

## 👨‍💻 作者

lovelycateman @ www.52pojie.cn

## 🙏 致谢

感谢所有使用和支持本工具的用户！

---

## 📧 反馈与建议

如有问题或建议，欢迎访问 www.52pojie.cn 反馈。

---

**祝您使用愉快！ 🎉**

